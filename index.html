<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>PRTCL 108 — ADM MODE</title>
  <meta name="description" content="PRTCL 108 — интерактивный терминал сканирования персонажа. MULTIPASS, выбор, последствия, прокачка."/>

  <style>
    :root{
      --bg0:#05070c;
      --bg1:#070a12;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.10);
      --line: rgba(255,255,255,.12);
      --line2: rgba(200, 240, 255, .18);
      --txt:#eaf2ff;
      --muted: rgba(234,242,255,.72);

      --pearl1:#f7f1ff;
      --pearl2:#e8fbff;
      --pearl3:#d7d1ff;

      --ice:#bff6ff;
      --violet:#c6b4ff;
      --warn:#ffe9a8;

      --shadow: 0 14px 60px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 26px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--txt);
      font-family: var(--sans);
      overflow-x:hidden;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(198,180,255,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 0%, rgba(191,246,255,.14), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* Subtle “ship” grid */
    .grid{
      position:fixed; inset:0; pointer-events:none;
      background:
        linear-gradient(to right, rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 42px 42px;
      mask-image: radial-gradient(900px 600px at 50% 35%, rgba(0,0,0,1), transparent 75%);
      opacity:.35;
      mix-blend-mode: overlay;
    }

    /* Floating warning lines */
    .lines{
      position:fixed; inset:0; pointer-events:none;
      opacity:.35;
      background:
        repeating-linear-gradient(115deg,
          transparent 0 18px,
          rgba(255,255,255,.07) 18px 19px,
          transparent 19px 38px);
      mask-image: radial-gradient(900px 600px at 50% 40%, rgba(0,0,0,1), transparent 70%);
      mix-blend-mode: overlay;
    }

    .wrap{
      min-height:100%;
      padding: 26px 16px 56px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .shell{
      width:min(1100px, 100%);
      display:grid;
      gap:16px;
      grid-template-columns: 1.1fr .9fr;
    }

    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
    }

    /* Header */
    header{
      grid-column: 1 / -1;
      padding: 18px 18px 6px;
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .brand{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .title{
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: clamp(28px, 4vw, 46px);
      line-height: 1;
      margin:0;
      background: linear-gradient(90deg, var(--pearl1), var(--pearl2), var(--pearl3), var(--pearl2), var(--pearl1));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
      filter: drop-shadow(0 0 18px rgba(191,246,255,.18));
      animation: shimmer 3.8s linear infinite;
      background-size: 220% 100%;
    }
    @keyframes shimmer{
      0%{ background-position: 0% 50%; }
      100%{ background-position: 220% 50%; }
    }

    .sub{
      margin: 10px 0 0;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 13px;
      letter-spacing: .03em;
    }

    .adm{
      display:flex;
      align-items:center;
      gap:10px;
      font-family: var(--mono);
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      box-shadow: inset 0 0 0 1px rgba(191,246,255,.10);
      user-select:none;
    }
    .pulseDot{
      width:10px; height:10px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, var(--ice));
      box-shadow: 0 0 0 0 rgba(191,246,255,.35);
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(191,246,255,.35); }
      70%{ box-shadow:0 0 0 14px rgba(191,246,255,0); }
      100%{ box-shadow:0 0 0 0 rgba(191,246,255,0); }
    }

    .adm b{
      color: rgba(255,255,255,.92);
      letter-spacing:.08em;
    }

    /* Panels */
    .panel{
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 300px at 20% 0%, rgba(198,180,255,.20), transparent 55%),
                  radial-gradient(600px 300px at 80% 0%, rgba(191,246,255,.18), transparent 55%);
      opacity:.35;
      pointer-events:none;
    }
    .panelHead{
      padding: 14px 16px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:relative;
    }
    .panelHead h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-family: var(--mono);
      color: rgba(255,255,255,.88);
    }
    .tag{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.74);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }

    .panelBody{ padding: 16px; position:relative; }

    /* Terminal */
    .terminal{
      font-family: var(--mono);
    }
    .console{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding: 14px 14px 12px;
      min-height: 148px;
      box-shadow: inset 0 0 0 1px rgba(191,246,255,.08);
      position:relative;
      overflow:hidden;
    }
    .console::after{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), transparent 30%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0 1px, transparent 1px 3px);
      opacity:.25;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    .log{
      margin:0;
      white-space:pre-wrap;
      color: rgba(234,242,255,.86);
      line-height: 1.45;
      font-size: 13px;
    }
    .caret{
      display:inline-block;
      width: 10px;
      height: 16px;
      margin-left: 2px;
      background: rgba(191,246,255,.85);
      vertical-align: -3px;
      animation: blink 1s steps(1) infinite;
    }
    @keyframes blink{ 50%{ opacity:0; } }

    .form{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .form{ grid-template-columns: 1fr; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size: 12px;
      color: rgba(255,255,255,.75);
      letter-spacing:.08em;
      text-transform: uppercase;
    }
    input, select{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--txt);
      padding: 12px 12px;
      font-family: var(--mono);
      outline:none;
      transition: .2s ease;
    }
    input:focus, select:focus{
      border-color: rgba(191,246,255,.38);
      box-shadow: 0 0 0 4px rgba(191,246,255,.10);
    }

    .btnRow{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      appearance:none;
      border:none;
      border-radius: 16px;
      padding: 12px 14px;
      color: rgba(5,7,12,.96);
      background: linear-gradient(135deg, var(--pearl1), var(--pearl2), var(--pearl3));
      font-family: var(--mono);
      font-weight: 800;
      letter-spacing:.08em;
      text-transform: uppercase;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      transition: transform .18s ease, filter .18s ease;
      position:relative;
      overflow:hidden;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.04); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      border:1px solid rgba(255,255,255,.16);
      box-shadow: inset 0 0 0 1px rgba(191,246,255,.08);
    }
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    /* Multipass */
    .passWrap{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }

    .pass{
      border-radius: 22px;
      background:
        radial-gradient(700px 300px at 20% 0%, rgba(191,246,255,.20), transparent 55%),
        radial-gradient(700px 300px at 80% 0%, rgba(198,180,255,.20), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.14);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .pass::after{
      content:"";
      position:absolute; inset:-1px;
      background:
        repeating-linear-gradient(120deg, transparent 0 18px, rgba(255,255,255,.06) 18px 19px, transparent 19px 36px);
      opacity:.22;
      mix-blend-mode: overlay;
      pointer-events:none;
      mask-image: radial-gradient(520px 260px at 55% 30%, rgba(0,0,0,1), transparent 72%);
    }

    .passTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .passTitle{
      margin:0;
      font-family: var(--mono);
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 900;
      font-size: 14px;
      color: rgba(255,255,255,.92);
    }
    .passSub{
      margin:6px 0 0;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.70);
    }

    .stamp{
      width: 84px;
      height: 84px;
      border-radius: 50%;
      border: 2px solid rgba(191,246,255,.65);
      box-shadow: 0 0 0 8px rgba(191,246,255,.08), inset 0 0 0 2px rgba(255,255,255,.10);
      display:grid;
      place-items:center;
      transform: rotate(-16deg) scale(.92);
      opacity:.0;
      filter: blur(2px);
      transition: .55s cubic-bezier(.2,.9,.2,1);
      position:relative;
      overflow:hidden;
      background: rgba(0,0,0,.22);
    }
    .stamp::before{
      content:"";
      position:absolute; inset:-10px;
      background: conic-gradient(from 90deg, rgba(191,246,255,.0), rgba(191,246,255,.55), rgba(198,180,255,.35), rgba(191,246,255,.0));
      opacity:.55;
      filter: blur(2px);
      animation: spin 3.4s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    .stamp b{
      position:relative;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.18em;
      text-transform: uppercase;
      color: rgba(234,242,255,.90);
      text-shadow: 0 0 14px rgba(191,246,255,.35);
    }
    .stamped .stamp{
      opacity: 1;
      filter: blur(0);
      transform: rotate(-16deg) scale(1);
    }

    .passGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 12px;
    }
    .kv{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 10px 10px;
    }
    .kv .k{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.65);
      letter-spacing:.10em;
      text-transform: uppercase;
    }
    .kv .v{
      margin-top:6px;
      font-family: var(--mono);
      font-weight: 800;
      color: rgba(255,255,255,.92);
      letter-spacing:.04em;
      font-size: 13px;
    }
    .kv.wide{ grid-column: 1 / -1; }

    .avatarRow{
      margin-top: 12px;
      display:flex;
      gap:12px;
      align-items:stretch;
    }
    .avatarCard{
      flex: 0 0 120px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      box-shadow: inset 0 0 0 1px rgba(191,246,255,.08);
      position:relative;
      overflow:hidden;
      display:grid;
      place-items:center;
    }
    .avatarCard canvas{ width:100%; height:100%; display:block; }

    .traits{
      flex:1;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
    }
    .traits h3{
      margin: 2px 0 8px;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,.82);
    }
    .traits ul{
      margin:0;
      padding-left: 16px;
      color: rgba(255,255,255,.80);
      font-family: var(--mono);
      font-size: 12px;
      line-height:1.5;
    }

    /* Story */
    .story{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .scene{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      box-shadow: inset 0 0 0 1px rgba(191,246,255,.07);
      padding: 14px 14px;
      position:relative;
      overflow:hidden;
    }
    .scene::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent 35%);
      opacity:.25;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    .sceneTitle{
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.86);
      margin:0 0 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sceneTitle span{
      color: rgba(255,255,255,.60);
      font-weight:700;
      letter-spacing:.10em;
    }

    .narr{
      margin:0;
      color: rgba(234,242,255,.86);
      font-size: 14px;
      line-height: 1.55;
    }

    .choices{
      display:grid;
      gap:10px;
      margin-top: 12px;
    }
    .choice{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition: .18s ease;
      font-family: var(--mono);
      color: rgba(255,255,255,.88);
    }
    .choice:hover{
      border-color: rgba(191,246,255,.35);
      box-shadow: 0 0 0 4px rgba(191,246,255,.10);
      transform: translateY(-1px);
    }
    .choice:active{ transform: translateY(1px); }
    .choice small{
      display:block;
      margin-top:6px;
      color: rgba(255,255,255,.62);
      letter-spacing:.02em;
      font-size: 12px;
      line-height:1.4;
    }

    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stat{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 10px 10px;
    }
    .stat .name{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,.65);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .stat .val{
      font-family: var(--mono);
      font-weight: 900;
      letter-spacing:.06em;
      margin-top:8px;
      font-size: 18px;
      color: rgba(255,255,255,.92);
    }
    .bar{
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:50%;
      background: linear-gradient(90deg, rgba(191,246,255,.8), rgba(198,180,255,.75));
      filter: drop-shadow(0 0 10px rgba(191,246,255,.18));
      transition: width .55s cubic-bezier(.2,.9,.2,1);
    }

    /* Hidden layers */
    .sealed{
      position:relative;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding: 14px;
      overflow:hidden;
    }
    .sealed.locked{
      filter: saturate(.9);
    }
    .veil{
      position:absolute; inset:0;
      background:
        radial-gradient(600px 280px at 50% 10%, rgba(191,246,255,.18), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.70));
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:10px;
      flex-direction:column;
      padding: 18px;
      border-radius: 18px;
      backdrop-filter: blur(6px);
    }
    .veil h4{
      margin:0;
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }
    .veil p{
      margin:0;
      color: rgba(255,255,255,.70);
      font-family: var(--mono);
      font-size: 12px;
      line-height:1.5;
      max-width: 46ch;
    }

    /* Diagram canvas */
    .diag{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      box-shadow: inset 0 0 0 1px rgba(191,246,255,.07);
      overflow:hidden;
    }
    .diag canvas{
      display:block;
      width:100%;
      height: 220px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: 16px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.88);
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.04em;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: .28s ease;
      backdrop-filter: blur(8px);
      z-index: 999;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }
  </style>
</head>

<body>
  <div class="grid"></div>
  <div class="lines"></div>

  <div class="wrap">
    <div class="shell">

      <header>
        <div class="brand">
          <div>
            <h1 class="title">PRTCL 108</h1>
            <p class="sub">Terminal: Скан персонажа → MULTIPASS → Вход → Выбор → Последствия</p>
          </div>
          <div class="adm" title="Режим активен">
            <span class="pulseDot"></span>
            <b>ADM MODE</b>
          </div>
        </div>
      </header>

      <!-- LEFT: Terminal + Story -->
      <section class="panel terminal">
        <div class="panelHead">
          <h2>Terminal</h2>
          <span class="tag" id="tagStatus">ОЖИДАНИЕ СКАНА</span>
        </div>
        <div class="panelBody">

          <div class="console" aria-live="polite">
            <pre class="log" id="log"></pre><span class="caret"></span>
          </div>

          <div class="form" id="form">
            <div class="field">
              <label for="dob">Дата рождения</label>
              <input id="dob" type="date" value="1996-08-01"/>
            </div>
            <div class="field">
              <label for="place">Место рождения</label>
              <input id="place" type="text" value="Нальчик, Россия" placeholder="Город, страна"/>
            </div>
            <div class="field">
              <label for="gender">Аватар</label>
              <select id="gender">
                <option value="F" selected>Женский силуэт</option>
                <option value="M">Мужской силуэт</option>
                <option value="X">Без привязки</option>
              </select>
            </div>
            <div class="field">
              <label for="alias">Позывной</label>
              <input id="alias" type="text" value="MARATINA" placeholder="Например: N0NAME / RAGE / GLITCH"/>
            </div>
          </div>

          <div class="btnRow">
            <button class="btn" id="btnScan">СКАН-ЛУЧ</button>
            <button class="btn secondary" id="btnReset">СБРОС</button>
          </div>

          <div style="height:14px"></div>

          <div class="story" id="story"></div>

        </div>
      </section>

      <!-- RIGHT: Multipass + Stats + Diagram -->
      <aside class="panel">
        <div class="panelHead">
          <h2>MULTIPASS</h2>
          <span class="tag" id="tagClearance">CLEARANCE: —</span>
        </div>
        <div class="panelBody">

          <div class="passWrap">
            <div class="pass" id="pass">
              <div class="passTop">
                <div>
                  <p class="passTitle">MULTIPASS / PRTCL 108</p>
                  <p class="passSub" id="passSub">Сгенерируй доступ через Terminal.</p>
                </div>
                <div class="stamp" id="stamp" aria-hidden="true"><b>SEAL</b></div>
              </div>

              <div class="passGrid" id="passGrid" style="opacity:.6">
                <div class="kv"><div class="k">ID</div><div class="v">—</div></div>
                <div class="kv"><div class="k">ORIGIN</div><div class="v">—</div></div>
                <div class="kv"><div class="k">SEED</div><div class="v">—</div></div>
                <div class="kv"><div class="k">ROLE</div><div class="v">—</div></div>
                <div class="kv wide"><div class="k">SIGNATURE</div><div class="v">—</div></div>
              </div>

              <div class="avatarRow">
                <div class="avatarCard" title="Мини-аватар (как права)">
                  <canvas id="miniAvatar" width="240" height="240"></canvas>
                </div>
                <div class="traits">
                  <h3>База персонажа</h3>
                  <ul id="traitList">
                    <li>Здесь появится ядро характера.</li>
                    <li>И первые параметры допуска.</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="panelHead" style="border-radius:18px; border:1px solid rgba(255,255,255,.10); margin-top:12px; background: rgba(255,255,255,.03);">
              <h2 style="margin:0">Параметры</h2>
              <span class="tag" id="tagPhase">ФАЗА: 0</span>
            </div>

            <div class="stats" id="stats">
              <!-- stats injected -->
            </div>

            <div class="panelHead" style="border-radius:18px; border:1px solid rgba(255,255,255,.10); margin-top:12px; background: rgba(255,255,255,.03);">
              <h2 style="margin:0">Схема строения</h2>
              <span class="tag">WAVE / CRYSTAL / HEX</span>
            </div>

            <div class="diag">
              <canvas id="diag" width="900" height="220"></canvas>
            </div>

            <div class="sealed locked" id="sealedBox" style="margin-top:12px;">
              <div id="sealedContent">
                <div class="sceneTitle" style="margin:0 0 10px;">
                  <div>Скрытый слой</div>
                  <span id="lockedKey">КЛЮЧ: —</span>
                </div>
                <p class="narr" id="hiddenText" style="margin:0;">
                  Здесь будет твой “второй контур” — блокер и инструкция обхода. Он открывается только после выбора в первой сцене.
                </p>
              </div>

              <div class="veil" id="veil">
                <h4>ЗАПЕЧАТАНО</h4>
                <p>Нужен триггер. Сделай выбор в сцене “Порог”. Тогда печать сработает и слой станет доступен.</p>
                <button class="btn secondary" id="btnUnlockHint" style="padding:10px 12px;">ПОКАЗАТЬ ПОДСКАЗКУ</button>
              </div>
            </div>

          </div>

        </div>
      </aside>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---------- Utilities ----------
    const $ = (sel) => document.querySelector(sel);
    const logEl = $("#log");
    const storyEl = $("#story");
    const tagStatus = $("#tagStatus");
    const tagClearance = $("#tagClearance");
    const tagPhase = $("#tagPhase");
    const passEl = $("#pass");
    const passSub = $("#passSub");
    const passGrid = $("#passGrid");
    const traitList = $("#traitList");
    const toastEl = $("#toast");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    // Deterministic RNG from seed (mulberry32)
    function hashString(str){
      let h = 2166136261 >>> 0;
      for (let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }
    function mulberry32(a){
      return function(){
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }

    // ---------- Game State ----------
    const state = {
      scanned: false,
      phase: 0,
      clearance: 0,
      id: "—",
      origin: "—",
      seed: "—",
      role: "—",
      signature: "—",
      alias: "—",
      gender: "F",
      dob: "—",
      place: "—",
      stats: {
        "ЭНЕРГИЯ": 50,
        "ВОЛЯ": 50,
        "ХОЛОД": 50,
        "РИСК": 50,
        "КОНТРОЛЬ": 50,
        "ИНТУИЦИЯ": 50
      },
      key: null,
      choiceHistory: []
    };

    const MANIFEST = [
      "Если система закрывает двери — я становлюсь дверью. Я не прошу разрешения. Я создаю протокол.",
      "Я не ломаю правила. Я перепрошиваю реальность.",
      "Они называют это ошибкой. Я называю это силой.",
      "Там, где у других границы — у меня маршрут.",
      "Мои решения не обсуждают. Их выполняют."
    ];

    const ROLES = [
      { name: "ПРОТОКОЛЬЩИК", desc:"Тот, кто превращает хаос в маршрут."},
      { name: "СИСТЕМНЫЙ ГЛИТЧ", desc:"Тот, кто проходит сквозь запреты."},
      { name: "АРХИВАРИУС ДОПУСКОВ", desc:"Тот, кто видит скрытые уровни."},
      { name: "КОМАНДИР ЛИНИИ РАЗРЫВА", desc:"Тот, кто режет ограничения."},
      { name: "ОПЕРАТОР ПЕЧАТИ", desc:"Тот, кто активирует доступ."}
    ];

    const TALENTS = [
      "Скан-интуиция: слышит ложь в интерфейсах.",
      "Холодный фокус: удерживает цель под шумом.",
      "Срыв ограничителей: ускорение без разрешения.",
      "Сборка смысла: превращает хаос в систему.",
      "Анти-страх: не откатывается назад.",
      "Режим клинка: режет лишнее одним действием."
    ];

    const BLOCKERS = [
      "Петля подтверждения: ждать знак вместо команды.",
      "Шум внешних голосов: чужие правила в твоей голове.",
      "Перфекционистская заморозка: идеал = стоп.",
      "Срыв в крайности: “или всё, или ничего”.",
      "Привязка к оценке: измерять себя чужими глазами."
    ];

    // ---------- UI builders ----------
    function typeToLog(lines, speed=18){
      // lines: array of strings
      return new Promise((resolve)=>{
        let text = "";
        let idxLine = 0, idxChar = 0;

        function step(){
          if (idxLine >= lines.length){
            logEl.textContent = text;
            resolve();
            return;
          }
          const line = lines[idxLine];
          if (idxChar <= line.length){
            const add = line.slice(0, idxChar);
            const merged = lines.slice(0, idxLine).join("\n") + (idxLine>0 ? "\n" : "") + add;
            logEl.textContent = merged;
            idxChar++;
            setTimeout(step, speed);
          } else {
            idxLine++;
            idxChar = 0;
            setTimeout(step, speed);
          }
        }
        step();
      });
    }

    function renderStats(){
      const host = $("#stats");
      host.innerHTML = "";
      Object.entries(state.stats).forEach(([name, val])=>{
        const box = document.createElement("div");
        box.className = "stat";
        box.innerHTML = `
          <div class="name">
            <span>${name}</span>
            <span>${val}</span>
          </div>
          <div class="bar"><div class="fill" style="width:${clamp(val,0,100)}%"></div></div>
        `;
        host.appendChild(box);
      });
    }

    function setPhase(p){
      state.phase = p;
      tagPhase.textContent = `ФАЗА: ${p}`;
    }

    function setClearance(c){
      state.clearance = c;
      const label = c <= 0 ? "—" : `C-${String(c).padStart(2,"0")}`;
      tagClearance.textContent = `CLEARANCE: ${label}`;
    }

    function applyDelta(delta){
      for (const [k, v] of Object.entries(delta)){
        if (state.stats[k] == null) continue;
        state.stats[k] = clamp(state.stats[k] + v, 0, 100);
      }
      renderStats();
      drawDiagram();
    }

    function normalizeDate(iso){
      // iso: YYYY-MM-DD
      if (!iso || iso.length < 10) return "—";
      const [y,m,d] = iso.split("-");
      return `${d}.${m}.${y}`;
    }

    function makeId(rng){
      const A="ABCDEFGHJKMNPQRSTUVWXYZ";
      const N="23456789";
      const pick = (s)=> s[Math.floor(rng()*s.length)];
      return `P-${pick(A)}${pick(A)}${pick(N)}${pick(N)}-${pick(A)}${pick(N)}${pick(A)}${pick(N)}`;
    }

    function choose(arr, rng){
      return arr[Math.floor(rng()*arr.length)];
    }

    function renderPass(){
      passSub.textContent = "Доступ выдан. Печать активна. Терминал синхронизирован.";
      passGrid.style.opacity = "1";
      passGrid.innerHTML = `
        <div class="kv"><div class="k">ID</div><div class="v">${state.id}</div></div>
        <div class="kv"><div class="k">ORIGIN</div><div class="v">${state.origin}</div></div>
        <div class="kv"><div class="k">SEED</div><div class="v">${state.seed}</div></div>
        <div class="kv"><div class="k">ROLE</div><div class="v">${state.role}</div></div>
        <div class="kv wide"><div class="k">SIGNATURE</div><div class="v">${state.signature}</div></div>
      `;
      passEl.classList.add("stamped");
      $("#stamp").setAttribute("aria-hidden","false");
    }

    function renderTraits(rng){
      const roleObj = ROLES.find(r => r.name === state.role) || ROLES[0];
      const t1 = choose(TALENTS, rng);
      const t2 = choose(TALENTS, rng);
      const t3 = choose(TALENTS, rng);

      traitList.innerHTML = `
        <li><b>Роль:</b> ${roleObj.name} — ${roleObj.desc}</li>
        <li><b>Талант:</b> ${t1}</li>
        <li><b>Талант:</b> ${t2}</li>
        <li><b>Талант:</b> ${t3}</li>
      `;
    }

    // ---------- Avatar drawing (simple silhouette / tech) ----------
    function drawMiniAvatar(){
      const c = $("#miniAvatar");
      const ctx = c.getContext("2d");
      const w = c.width, h = c.height;

      ctx.clearRect(0,0,w,h);

      // background
      const g = ctx.createLinearGradient(0,0,w,h);
      g.addColorStop(0, "rgba(198,180,255,.18)");
      g.addColorStop(.5, "rgba(191,246,255,.16)");
      g.addColorStop(1, "rgba(255,255,255,.06)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      // grid lines
      ctx.globalAlpha = 0.25;
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      ctx.lineWidth = 1;
      for(let x=20;x<w;x+=28){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
      }
      for(let y=20;y<h;y+=28){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }
      ctx.globalAlpha = 1;

      // silhouette
      ctx.save();
      ctx.translate(w/2, h/2 + 8);

      const isF = state.gender === "F";
      const isM = state.gender === "M";

      // glow
      ctx.shadowColor = "rgba(191,246,255,.35)";
      ctx.shadowBlur = 18;

      ctx.fillStyle = "rgba(0,0,0,.55)";
      ctx.strokeStyle = "rgba(191,246,255,.45)";
      ctx.lineWidth = 2;

      ctx.beginPath();
      // head
      ctx.arc(0, -62, 22, 0, Math.PI*2);

      // body
      if (isF){
        // shoulders to waist to hips (hourglass)
        ctx.moveTo(-34, -40);
        ctx.quadraticCurveTo(-52, -12, -30, 18);
        ctx.quadraticCurveTo(-18, 42, -26, 70);
        ctx.quadraticCurveTo(-10, 86, 0, 86);
        ctx.quadraticCurveTo(10, 86, 26, 70);
        ctx.quadraticCurveTo(18, 42, 30, 18);
        ctx.quadraticCurveTo(52, -12, 34, -40);
        ctx.closePath();
      } else if (isM){
        // broader torso
        ctx.moveTo(-42, -42);
        ctx.quadraticCurveTo(-56, -10, -44, 22);
        ctx.quadraticCurveTo(-32, 58, -20, 84);
        ctx.quadraticCurveTo(-6, 94, 0, 94);
        ctx.quadraticCurveTo(6, 94, 20, 84);
        ctx.quadraticCurveTo(32, 58, 44, 22);
        ctx.quadraticCurveTo(56, -10, 42, -42);
        ctx.closePath();
      } else {
        // neutral
        ctx.moveTo(-38, -42);
        ctx.quadraticCurveTo(-54, -10, -38, 26);
        ctx.quadraticCurveTo(-26, 62, -18, 90);
        ctx.quadraticCurveTo(-6, 98, 0, 98);
        ctx.quadraticCurveTo(6, 98, 18, 90);
        ctx.quadraticCurveTo(26, 62, 38, 26);
        ctx.quadraticCurveTo(54, -10, 38, -42);
        ctx.closePath();
      }

      ctx.fill();
      ctx.stroke();

      // visor line
      ctx.shadowBlur = 0;
      ctx.strokeStyle = "rgba(255,255,255,.22)";
      ctx.beginPath();
      ctx.moveTo(-16, -66);
      ctx.lineTo(16, -58);
      ctx.stroke();

      // badge (ID)
      ctx.fillStyle = "rgba(255,255,255,.10)";
      ctx.strokeStyle = "rgba(191,246,255,.30)";
      ctx.lineWidth = 1.6;
      ctx.beginPath();
      ctx.roundRect(-34, 10, 68, 22, 8);
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = "rgba(234,242,255,.85)";
      ctx.font = "900 11px ui-monospace, Menlo, monospace";
      ctx.textAlign = "center";
      ctx.fillText((state.id || "—").slice(0,8), 0, 26);

      ctx.restore();

      // corner marks
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      ctx.lineWidth = 2;
      const m=14;
      function corner(x,y,dx,dy){
        ctx.beginPath();
        ctx.moveTo(x,y+dy*m); ctx.lineTo(x,y); ctx.lineTo(x+dx*m,y);
        ctx.stroke();
      }
      corner(16,16,1,1);
      corner(w-16,16,-1,1);
      corner(16,h-16,1,-1);
      corner(w-16,h-16,-1,-1);
    }

    // ---------- Diagram (wave + crystal + hex) ----------
    function drawDiagram(){
      const c = $("#diag");
      const ctx = c.getContext("2d");
      const w = c.width, h = c.height;

      ctx.clearRect(0,0,w,h);

      // background
      const bg = ctx.createLinearGradient(0,0,w,h);
      bg.addColorStop(0, "rgba(198,180,255,.10)");
      bg.addColorStop(.5, "rgba(191,246,255,.08)");
      bg.addColorStop(1, "rgba(255,255,255,.03)");
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,w,h);

      // soft grid
      ctx.globalAlpha = 0.25;
      ctx.strokeStyle = "rgba(255,255,255,.15)";
      ctx.lineWidth = 1;
      for(let x=0;x<=w;x+=60){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
      }
      for(let y=0;y<=h;y+=44){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }
      ctx.globalAlpha = 1;

      // derive wave from stats
      const vals = Object.values(state.stats);
      const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      const amp = 18 + (avg/100)*26;
      const freq = 0.010 + (state.clearance*0.0008);
      const phase = (state.phase * 0.9);

      // wave
      ctx.strokeStyle = "rgba(191,246,255,.85)";
      ctx.lineWidth = 2.2;
      ctx.shadowColor = "rgba(191,246,255,.25)";
      ctx.shadowBlur = 12;

      ctx.beginPath();
      for(let x=0; x<=w; x++){
        const t = x*freq;
        const mod = (vals[(Math.floor(x/120)) % vals.length] / 100);
        const y = h*0.56 + Math.sin(t + phase) * (amp * (0.6 + mod));
        if (x===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();
      ctx.shadowBlur = 0;

      // crystal (diamond)
      const cx = w*0.22, cy = h*0.34;
      const size = 38 + (state.stats["ИНТУИЦИЯ"]/100)*20;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(-0.10);
      ctx.fillStyle = "rgba(255,255,255,.06)";
      ctx.strokeStyle = "rgba(198,180,255,.55)";
      ctx.lineWidth = 2;

      ctx.beginPath();
      ctx.moveTo(0, -size);
      ctx.lineTo(size*0.75, 0);
      ctx.lineTo(0, size);
      ctx.lineTo(-size*0.75, 0);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // inner facets
      ctx.strokeStyle = "rgba(191,246,255,.35)";
      ctx.lineWidth = 1.4;
      ctx.beginPath();
      ctx.moveTo(0,-size);
      ctx.lineTo(0,size);
      ctx.moveTo(-size*0.75,0);
      ctx.lineTo(size*0.75,0);
      ctx.stroke();
      ctx.restore();

      // hex (clearance)
      const hx = w*0.78, hy = h*0.36;
      const hexR = 40 + (state.stats["КОНТРОЛЬ"]/100)*16;
      ctx.save();
      ctx.translate(hx, hy);
      ctx.strokeStyle = "rgba(191,246,255,.55)";
      ctx.lineWidth = 2;
      ctx.fillStyle = "rgba(255,255,255,.05)";
      ctx.beginPath();
      for(let i=0;i<6;i++){
        const a = (Math.PI/3)*i - Math.PI/6;
        const px = Math.cos(a)*hexR;
        const py = Math.sin(a)*hexR;
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      }
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // rings
      ctx.globalAlpha = 0.7;
      ctx.strokeStyle = "rgba(198,180,255,.28)";
      ctx.lineWidth = 1.2;
      for(let r=hexR*0.45; r<hexR; r+=hexR*0.18){
        ctx.beginPath();
        for(let i=0;i<6;i++){
          const a = (Math.PI/3)*i - Math.PI/6;
          const px = Math.cos(a)*r;
          const py = Math.sin(a)*r;
          if(i===0) ctx.moveTo(px,py);
          else ctx.lineTo(px,py);
        }
        ctx.closePath();
        ctx.stroke();
      }
      ctx.globalAlpha = 1;

      // label
      ctx.fillStyle = "rgba(234,242,255,.78)";
      ctx.font = "900 12px ui-monospace, Menlo, monospace";
      ctx.textAlign = "center";
      ctx.fillText(`C-${String(state.clearance).padStart(2,"0")}`, 0, 4);
      ctx.restore();

      // footer text
      ctx.fillStyle = "rgba(255,255,255,.60)";
      ctx.font = "700 11px ui-monospace, Menlo, monospace";
      ctx.textAlign = "left";
      ctx.fillText("WAVE TRACE / ADM MODE", 14, h-14);
    }

    // ---------- Story Engine ----------
    function sceneCard({title, subtitle, text, choices}){
      const div = document.createElement("div");
      div.className = "scene";
      div.innerHTML = `
        <div class="sceneTitle">
          <div>${title}</div>
          <span>${subtitle || ""}</span>
        </div>
        <p class="narr">${text}</p>
        <div class="choices"></div>
      `;
      const ch = div.querySelector(".choices");
      if (choices && choices.length){
        choices.forEach((c, idx)=>{
          const b = document.createElement("button");
          b.className = "choice";
          b.type = "button";
          b.innerHTML = `${c.label}<small>${c.hint || ""}</small>`;
          b.addEventListener("click", ()=>c.onPick(idx));
          ch.appendChild(b);
        });
      }
      return div;
    }

    function clearStory(){
      storyEl.innerHTML = "";
    }

    function lockSealed(){
      $("#sealedBox").classList.add("locked");
      $("#veil").style.display = "flex";
      $("#lockedKey").textContent = "КЛЮЧ: —";
    }

    function unlockSealed(keyText, bodyText){
      $("#sealedBox").classList.remove("locked");
      $("#veil").style.display = "none";
      $("#lockedKey").textContent = `КЛЮЧ: ${keyText}`;
      $("#hiddenText").textContent = bodyText;
    }

    function buildScene1(rng){
      const mantra = choose(MANIFEST, rng);
      return sceneCard({
        title: "ПРЕДВАРИТЕЛЬНЫЙ ПРОТОКОЛ",
        subtitle: "INIT",
        text:
          `Терминал ловит твой сигнал и шепчет сухим машинным голосом.\n`+
          `«Результаты не обещают комфорт. Они дают направление».\n\n`+
          `Манифест на линии интерфейса:\n“${mantra}”`,
        choices: [
          { label:"ПРОДОЛЖИТЬ", hint:"Перейти к порогу доступа.", onPick: ()=>{
              setPhase(1);
              toast("ФАЗА 1: порог");
              storyEl.appendChild(buildScene2(rng));
              // disable first scene choices
              [...storyEl.querySelectorAll(".scene .choice")].slice(0,1).forEach(b=>b.disabled=true);
              storyEl.lastElementChild.scrollIntoView({behavior:"smooth", block:"start"});
            }
          }
        ]
      });
    }

    function buildScene2(rng){
      return sceneCard({
        title: "ПОРОГ",
        subtitle: "GATE 108",
        text:
          `Перед тобой три маршрута. Ни один не “правильный”.\n`+
          `Каждый — это контракт с последствиями.\n\n`+
          `Выбери, как ты входишь в мир:`,
        choices: [
          {
            label: "ВХОД ЧЕРЕЗ ХОЛОД",
            hint: "Сдержанно. Чётко. Без эмоций в протоколе.",
            onPick: ()=>{
              state.choiceHistory.push("cold");
              setPhase(2);
              setClearance(2);
              applyDelta({"ХОЛОД": +14, "КОНТРОЛЬ": +10, "РИСК": -6});
              unlockSealed("ICE-SEAL", "Блокер: Шум внешних голосов. Обход: выбери один голос — свой. Пиши команды коротко. Действуй по шагам. Не объясняйся.");
              toast("Печать: ICE-SEAL");
              storyEl.appendChild(buildScene3(rng, "cold"));
              disableChoicesInLastScene();
            }
          },
          {
            label: "ВХОД ЧЕРЕЗ РИСК",
            hint: "Быстро. Дерзко. С прицелом на скачок.",
            onPick: ()=>{
              state.choiceHistory.push("risk");
              setPhase(2);
              setClearance(3);
              applyDelta({"РИСК": +16, "ВОЛЯ": +10, "КОНТРОЛЬ": -6});
              unlockSealed("RAGE-SEAL", "Блокер: Перфекционистская заморозка. Обход: запускай сырое. Улучшай на ходу. Скорость важнее идеала.");
              toast("Печать: RAGE-SEAL");
              storyEl.appendChild(buildScene3(rng, "risk"));
              disableChoicesInLastScene();
            }
          },
          {
            label: "ВХОД ЧЕРЕЗ ИНТУИЦИЮ",
            hint: "Тихо. Точно. По внутренней частоте.",
            onPick: ()=>{
              state.choiceHistory.push("intuition");
              setPhase(2);
              setClearance(2);
              applyDelta({"ИНТУИЦИЯ": +16, "ЭНЕРГИЯ": +8, "РИСК": -4});
              unlockSealed("SIGNAL-SEAL", "Блокер: Петля подтверждения. Обход: решение принимается до знака. Знак — это подтверждение, не причина.");
              toast("Печать: SIGNAL-SEAL");
              storyEl.appendChild(buildScene3(rng, "intuition"));
              disableChoicesInLastScene();
            }
          }
        ]
      });
    }

    function disableChoicesInLastScene(){
      // disables choices in the last scene to prevent re-pick
      const scenes = [...storyEl.querySelectorAll(".scene")];
      const last = scenes[scenes.length-1];
      if (!last) return;
      [...last.querySelectorAll(".choice")].forEach(b=>b.disabled=true);
    }

    function buildScene3(rng, mode){
      const b = choose(BLOCKERS, rng);
      const phr = mode === "cold"
        ? "Ты не просишь. Ты фиксируешь."
        : mode === "risk"
        ? "Ты не ждёшь. Ты запускаешь."
        : "Ты не угадываешь. Ты считываешь.";
      return sceneCard({
        title: "ПЕРВЫЙ СБОЙ",
        subtitle: "ANOMALY",
        text:
          `Система реагирует на твой вход: краткий провал света, будто мир моргнул.\n`+
          `На панели появляется предупреждение: «Обнаружена аномалия поведения».\n\n`+
          `Вероятный блокер: ${b}.\n`+
          `${phr}\n\n`+
          `Что ты делаешь прямо сейчас?`,
        choices: [
          {
            label:"ЗАКРЕПИТЬ МАРШРУТ",
            hint:"Сделать шаг, который нельзя “отменить”.",
            onPick: ()=>{
              setPhase(3);
              setClearance(Math.max(state.clearance, 4));
              applyDelta({"ВОЛЯ": +10, "КОНТРОЛЬ": +8, "ЭНЕРГИЯ": -3});
              toast("Маршрут закреплён");
              storyEl.appendChild(buildScene4(rng));
              disableChoicesInLastScene();
            }
          },
          {
            label:"УСИЛИТЬ СИГНАЛ",
            hint:"Поднять частоту и пробить слой выше.",
            onPick: ()=>{
              setPhase(3);
              setClearance(Math.max(state.clearance, 4));
              applyDelta({"ИНТУИЦИЯ": +10, "РИСК": +6, "ХОЛОД": -2});
              toast("Сигнал усилен");
              storyEl.appendChild(buildScene4(rng));
              disableChoicesInLastScene();
            }
          }
        ]
      });
    }

    function buildScene4(rng){
      return sceneCard({
        title: "КАРТА ПУТИ",
        subtitle: "TRACE",
        text:
          `Терминал строит схему. Волна — твой текущий ритм.\n`+
          `Кристалл — ядро решений. Шестиугольник — стабильность допуска.\n\n`+
          `Финальный шаг демо: поставить подпись протокола и сохранить MULTIPASS.`,
        choices: [
          {
            label:"ПОДПИСАТЬ ПРОТОКОЛ",
            hint:"Печать усилится. CLEARANCE закрепится.",
            onPick: ()=>{
              setPhase(4);
              setClearance(Math.max(state.clearance, 5));
              applyDelta({"ВОЛЯ": +6, "ХОЛОД": +4, "КОНТРОЛЬ": +6, "ЭНЕРГИЯ": +2});
              passEl.classList.add("stamped");
              toast("Подпись принята. SEAL++");
              // “signature” refresh
              state.signature = `${state.alias} / ADM MODE / ${new Date().toISOString().slice(0,10)}`;
              renderPass();
              drawMiniAvatar();
              drawDiagram();
              disableChoicesInLastScene();
            }
          }
        ]
      });
    }

    // ---------- Scan flow ----------
    async function runScan(){
      const dob = $("#dob").value || "";
      const place = ($("#place").value || "").trim();
      const gender = $("#gender").value;
      const alias = ($("#alias").value || "").trim().toUpperCase() || "N0NAME";

      state.dob = normalizeDate(dob);
      state.place = place || "—";
      state.gender = gender;
      state.alias = alias;

      const seedStr = `${dob}|${place}|${gender}|${alias}`;
      const seedInt = hashString(seedStr);
      const rng = mulberry32(seedInt);

      state.scanned = true;
      setPhase(0);
      setClearance(1);

      state.id = makeId(rng);
      state.origin = (place || "UNKNOWN").toUpperCase();
      state.seed = String(seedInt).slice(0,10);
      state.role = choose(ROLES, rng).name;
      state.signature = `${alias} / PRTCL 108`;

      // reset stats around 50 with small deterministic deviations
      const keys = Object.keys(state.stats);
      keys.forEach((k, i)=>{
        const drift = Math.floor((rng()*2-1) * 14); // -14..+14
        state.stats[k] = clamp(50 + drift, 20, 80);
      });

      tagStatus.textContent = "СКАН ВЫПОЛНЕН";
      renderStats();
      renderPass();
      renderTraits(rng);
      drawMiniAvatar();
      drawDiagram();
      lockSealed();

      const lines = [
        "PRTCL 108 / ADM MODE",
        "Соединение установлено… OK",
        `Сигнатура обнаружена: ${alias}`,
        `Источник: ${state.origin}`,
        `SEED: ${state.seed}`,
        `Назначена роль: ${state.role}`,
        "Протокол готов. Вход разрешён при выборе маршрута."
      ];

      await typeToLog(lines, 14);

      clearStory();
      storyEl.appendChild(buildScene1(rng));
      storyEl.scrollIntoView({behavior:"smooth", block:"start"});
      toast("MULTIPASS выдан");
    }

    function resetAll(){
      state.scanned = false;
      state.phase = 0;
      state.choiceHistory = [];
      setPhase(0);
      setClearance(0);
      tagStatus.textContent = "ОЖИДАНИЕ СКАНА";
      passEl.classList.remove("stamped");
      passSub.textContent = "Сгенерируй доступ через Terminal.";
      passGrid.style.opacity = ".6";
      passGrid.innerHTML = `
        <div class="kv"><div class="k">ID</div><div class="v">—</div></div>
        <div class="kv"><div class="k">ORIGIN</div><div class="v">—</div></div>
        <div class="kv"><div class="k">SEED</div><div class="v">—</div></div>
        <div class="kv"><div class="k">ROLE</div><div class="v">—</div></div>
        <div class="kv wide"><div class="k">SIGNATURE</div><div class="v">—</div></div>
      `;
      traitList.innerHTML = `
        <li>Здесь появится ядро характера.</li>
        <li>И первые параметры допуска.</li>
      `;
      for (const k of Object.keys(state.stats)) state.stats[k] = 50;
      renderStats();
      drawDiagram();
      drawMiniAvatar();
      lockSealed();
      clearStory();
      typeToLog(["PRTCL 108 / ADM MODE", "Ожидание сигнала…"], 18);
      toast("Сброшено");
    }

    // ---------- Events ----------
    $("#btnScan").addEventListener("click", ()=>{
      $("#btnScan").disabled = true;
      runScan().finally(()=> $("#btnScan").disabled = false);
    });

    $("#btnReset").addEventListener("click", resetAll);

    $("#btnUnlockHint").addEventListener("click", ()=>{
      toast("Триггер: выбор в “Порог”");
    });

    // Initial render
    renderStats();
    typeToLog(["PRTCL 108 / ADM MODE", "Ожидание сигнала…"], 18);
    drawMiniAvatar();
    drawDiagram();
    lockSealed();
  </script>
</body>
</html>